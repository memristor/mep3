<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <SequenceStar>
            <Condition ID="DefaultTeamColorCondition" default_color="purple" />

            <!-- Set parameters -->
	    <Switch4 case_1="1y" case_2="1p" case_3="2y" case_4="2p" variable="{table}">
		    <Sequence name="case_1y">
			<SetBlackboard output_key="pose_home" value="1.08;0.6;0"/>
			<SetBlackboard output_key="base_pose_dispenser" value="1.246;-0.25;0"/>
			<SetBlackboard output_key="offset_pose_dispenser" value="0.044"/>
			<SetBlackboard output_key="pedestal_position" value="1.160;-0.660;135"/>
		    </Sequence>
		    <Sequence name="case_1p">
			<SetBlackboard output_key="pose_home" value="1.08;0.6;180"/>
			<SetBlackboard output_key="base_pose_dispenser" value="1.246;-0.25;0"/>
			<SetBlackboard output_key="offset_pose_dispenser" value="0.045"/>
			<SetBlackboard output_key="pedestal_position" value="1.160;-0.660;135"/>
		    </Sequence>
		    <Sequence name="case_2y">
			<SetBlackboard output_key="pose_home" value="1.08;0.6;0"/>
			<SetBlackboard output_key="base_pose_dispenser" value="1.243;-0.25;0"/>
			<SetBlackboard output_key="offset_pose_dispenser" value="0.046"/>
			<SetBlackboard output_key="pedestal_position" value="1.160;-0.660;135"/>
		    </Sequence>
		    <Sequence name="case_2p">
			<SetBlackboard output_key="pose_home" value="1.08;0.6;180"/>
			<SetBlackboard output_key="base_pose_dispenser" value="1.235;-0.25;0"/>
			<SetBlackboard output_key="offset_pose_dispenser" value="0.044"/>
			<SetBlackboard output_key="pedestal_position" value="1.155;-0.655;135"/>
		    </Sequence>
		    <Sequence name="default">
			<SetBlackboard output_key="pose_home" value="1.08;0.6;0"/>
			<SetBlackboard output_key="base_pose_dispenser" value="1.240;-0.25;0"/>
			<SetBlackboard output_key="offset_pose_dispenser" value="0.048"/>
			<SetBlackboard output_key="pedestal_position" value="1.160;-0.660;135"/>
		    </Sequence>
            </Switch4>

            <Motion command="forward" velocity_linear="0.9" velocity_angular="6.0" acceleration_angular="8.0" value="0" />

            <WaitMatchStart state="2" />
            <!--Wait duration="1" /-->
	    <SequenceStar>
		    <ForceSuccess>
			<Timeout msec="100000">
			<Sequence>
			    <ForceSuccess>
				<Timeout msec="85000">
				    <TaskSequence>
					<SubTree ID="skill_retract_hands" __shared_blackboard="true" />
					<SubTree ID="task_replica_and_statuette" __shared_blackboard="true" />
					<!--Action ID="PreciseNavigateToAction" behavior_tree="forward" goal="1.21;-0.25;0" /-->
					<SubTree ID="collect_dispensers" __shared_blackboard="true" />
					<SubTree ID="leave_on_gallery" __shared_blackboard="true" />
				    </TaskSequence>
				</Timeout>
			    </ForceSuccess>

			    <!-- Go home -->
		            <Motion command="forward" value="-0.03" />
			    <Navigate goal="{pose_home}" />
			    <ScoreboardTask points="20" task="go_home_small"/>
			</Sequence>
			</Timeout>
		    </ForceSuccess>
	    </SequenceStar>

            <!-- Stop the motion driver / `can_id` and `message` must be decimals, not hexadecimals. -->
            <CanbusSend can_id="512" message="15" />
            <VacuumPump label="arm_mid_connector" connect="0" />
            <VacuumPump label="arm_left_connector" connect="0" />
            <VacuumPump label="arm_right_connector" connect="0" />
            <Dynamixel label="arm_right_motor_base" velocity="777" />
            <Wait duration="10000.0" name="Wait Indefinitely" />
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="skill_retract_hands">
        <Parallel failure_threshold="1" success_threshold="6">
            <Dynamixel label="arm_right_motor_base" position="0" />
            <Dynamixel label="arm_right_motor_mid" position="-30" />
            <Dynamixel label="arm_right_motor_gripper" position="0" />
            <Dynamixel label="arm_left_motor_base" position="0" />
            <Dynamixel label="arm_left_motor_mid" position="-30" />
            <Dynamixel label="arm_left_motor_gripper" position="0" />

        </Parallel>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="collect_dispensers">
        <Fallback>
            <Sequence>
		<PreciseNavigate goal="1.15;-0.25;0" />
                <Dynamixel label="hand_mid_S" position="-3" />
                <VacuumPump label="arm_mid_connector" connect="1" />
		<!-- STOL 1 -->
                <!--PreciseNavigate goal="1.241;-0.25;0" /-->
		<!-- STOL 2 -->
		<PreciseNavigate goal="{base_pose_dispenser}" />
                <Dynamixel label="hand_mid_S" position="-90" />
                <ScoreboardTask points="1" task="remove_blue_sample_from_dispenser"/>
                <SubTree ID="skill_move_sample_from_mid_to_right" __shared_blackboard="true" />
                <!-- Second puck  ////////// -->
                <Dynamixel label="hand_mid_S" position="-3" />
                <VacuumPump label="arm_mid_connector" connect="1" />
                <Motion command="forward" value="-0.030" />
		<Motion command="forward" value="{offset_pose_dispenser}" />
                <Dynamixel label="hand_mid_S" position="-90" />
                <ScoreboardTask points="1" task="remove_green_sample_from_dispenser"/>
                <SubTree ID="skill_move_sample_from_mid_to_left" __shared_blackboard="true" />
                <!-- Third puck  ////////// -->
                <Motion command="forward" value="-0.030" />
                <Dynamixel label="hand_mid_S" position="-3" />
                <VacuumPump label="arm_mid_connector" connect="1" />
		<Motion command="forward" value="{offset_pose_dispenser}" />
                <Dynamixel label="hand_mid_S" position="-90" />
                <ScoreboardTask points="1" task="remove_red_sample_from_dispenser"/>
                <!-- Go back a little bit ////////// -->
                <Motion command="forward" value="-0.10" />
            </Sequence>
            
	    <Motion command="forward" value="-0.1" />

        </Fallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="skill_move_sample_from_mid_to_right">
	<Sequence>
            <VacuumPump label="arm_right_connector" connect="1" />
	    <Dynamixel label="arm_left_motor_mid" position="-60" velocity="200"/>
	    <Dynamixel label="arm_right_motor_gripper" position="50" />
            <Dynamixel label="arm_right_motor_mid" position="10" />
            <VacuumPump label="arm_mid_connector" connect="0" />
            <Dynamixel label="arm_right_motor_mid" position="-10" />
            <Dynamixel label="arm_right_motor_gripper" position="40" />
            <VacuumPump label="arm_mid_connector" connect="0" />
            <Dynamixel label="arm_right_motor_base" position="-90" />
            <VacuumPump label="arm_mid_connector" connect="0" />
            <Parallel failure_threshold="1" success_threshold="2">
		        <Dynamixel label="arm_right_motor_mid" position="-10" velocity="100"/>
		        <Dynamixel label="arm_right_motor_gripper" position="0" velocity="100" />
            </Parallel>
	</Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="skill_move_sample_from_mid_to_left">
	<Sequence>
            <VacuumPump label="arm_left_connector" connect="1" />
            <Dynamixel label="arm_left_motor_gripper" position="50" />
            <Dynamixel label="arm_left_motor_mid" position="-5" />
            <VacuumPump label="arm_mid_connector" connect="0" />
            <Dynamixel label="arm_left_motor_mid" position="-23" />
            <Dynamixel label="arm_left_motor_gripper" position="60" />
            <VacuumPump label="arm_mid_connector" connect="0" />
            <Dynamixel label="arm_left_motor_base" position="90" />
            <VacuumPump label="arm_mid_connector" connect="0" />
            <Parallel failure_threshold="1" success_threshold="2">
		<Dynamixel label="arm_left_motor_mid" position="-10" velocity="100"/>
		<Dynamixel label="arm_left_motor_gripper" position="0" velocity="100"/>
	    </Parallel>
	</Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="leave_on_gallery">
        <ForceSuccess>
            <Sequence>
                <Motion command="forward" velocity_linear="0.7" velocity_angular="6.0" acceleration_angular="8.0" value="0" />
		<SubTreePlus ID="SafePreciseNavigate" goal="0.79;0.61;90" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                <!--PreciseNavigate goal="0.79;0.61;90" /-->
                <Motion command="forward" velocity_linear="0.4" velocity_angular="6.0" acceleration_angular="8.0" value="0" />
                <Motion command="forward" value="0.16" />
                <Motion command="forward" velocity_linear="0.6" velocity_angular="6.0" acceleration_angular="8.0" value="0" />
                <Parallel failure_threshold="1" success_threshold="2">
                    <Dynamixel label="arm_right_motor_mid" position="41" velocity="90"/>
                    <Dynamixel label="arm_left_motor_mid" position="41" velocity="90"/>
                </Parallel>
                <VacuumPump label="arm_left_connector" connect="0" />
                 <ScoreboardTask points="6" task="install_blue_sample_on_gallery"/>
                <VacuumPump label="arm_right_connector" connect="0" />
                 <Motion command="forward" value="-0.16" />
                 <ScoreboardTask points="6" task="install_green_sample_on_gallery"/>
                <Parallel failure_threshold="1" success_threshold="2">
                    <Dynamixel label="arm_right_motor_mid" position="-20" />
                    <Dynamixel label="arm_left_motor_mid" position="-20" />
                </Parallel>
                <Parallel failure_threshold="1" success_threshold="3">
                    <Dynamixel label="arm_right_motor_base" position="0" />
                    <Dynamixel label="arm_left_motor_base" position="0" />
                    <Dynamixel label="hand_mid_S" position="-90" />
                </Parallel>

                <!-- Leave red pack ////////// -->
	        <Wait duration="100" />

                <SubTree ID="skill_move_sample_from_mid_to_left" __shared_blackboard="true" />
                <PreciseNavigate goal="0.50;0.65;90" />

               
                <!--PreciseNavigate goal="0.50;0.77;90" /-->
		<Motion command="forward" velocity_linear="0.3" velocity_angular="6.0" acceleration_angular="8.0" value="0.15" />
                <Dynamixel label="arm_left_motor_mid" position="41" velocity="90"/>
                <VacuumPump label="arm_left_connector" connect="0" />

		<Motion command="forward" velocity_linear="0.5" velocity_angular="6.0" acceleration_angular="8.0" value="0" />
	        <Motion command="forward" value="-0.16" />
                 <ScoreboardTask points="6" task="install_red_sample_on_gallery"/>
                <Parallel failure_threshold="1" success_threshold="2">
                    <Dynamixel label="arm_right_motor_mid" position="-20" velocity="270" />
                    <Dynamixel label="arm_left_motor_mid" position="-20" velocity="270"/>
                </Parallel>
	        <Motion command="forward" value="-0.16" />

            </Sequence>
        </ForceSuccess>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="task_excavation_squares">
        <Sequence>
            <Action ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_G" timeout="5" position="-38" />
            <SubTreePlus ID="SafePreciseNavigate" goal="0.807;-0.78;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="0.675;-0.78;0" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="0.493;-0.78;0" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="0.307;-0.78;0" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="0.121;-0.78;0" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="-0.06;-0.78;0" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="-0.243;-0.78;0" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="-0.428;-0.78;0" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <ForceSuccess>
                <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-23" />
            </ForceSuccess>
            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
            <SubTreePlus ID="SafePreciseNavigate" goal="-0.428;-0.78;1.570796" type="forward" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_Dz" timeout="5" position="-90" />
            <Action velocity="90" ID="DynamixelCommandAction" result="0" tolerance="5" server_name="dynamixel_command/hand_side_G" timeout="5" position="90" />
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="task_replica_and_statuette">
        <Sequence>
            <!--Navigate behavior_tree="" goal="1;-0.45;60" /-->
            <Parallel failure_threshold="1" success_threshold="3">
				<Dynamixel label="arm_left_motor_base" position="0" />
				<Dynamixel label="arm_left_motor_mid" position="-30" />
				<Dynamixel label="arm_left_motor_gripper" position="0" />
            </Parallel>
            <!--SubTreePlus ID="SafePreciseNavigate" goal="1.05;-0.55;3.35619" type="backward" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /-->
            <SubTreePlus ID="SafePreciseNavigate" goal="1.05;-0.55;135" type="backward" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            <!--PreciseNavigate behavior_tree="backward" goal="1.05;-0.55;135" /-->
            <!--PreciseNavigate behavior_tree="backward" goal="1.160;-0.660;135" /-->
	    <PreciseNavigate behavior_tree="backward" goal="{pedestal_position}" />
            <ScoreboardTask points="4" task="begin_action" />
            <Dynamixel label="hand_mid_L" timeout="2" position="-90" velocity="70" />
            <ScoreboardTask points="5" task="remove_statuette_from_pedestal" />
            <ScoreboardTask points="10" task="install_replica_on_pedestal" />
            <Motion value="0.3" command="forward" />
            <!--Navigate goal="1.25;0.65;-90"/-->
            <Motion command="forward" velocity_linear="0.7" velocity_angular="6.0" acceleration_angular="8.0" value="0" />
            <PreciseNavigate behavior_tree="backward" goal="1.295;0.83;-90" />
            <Motion value="-0.064" command="forward" />
            <Dynamixel label="hand_mid_L" position="15" velocity="540" />
            <ScoreboardTask points="15" task="install_statuette_on_display_cabinet" />
            <ScoreboardTask points="5" task="install_statuette_in_hause" />
            <Motion value="0.07" command="forward" />
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="SafePreciseNavigate">
        <SequenceStar>
            <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
            <RecoveryNode number_of_retries="3" name="FollowPath">
                <PreciseNavigate goal="{goal}" behavior_tree="{type}" />
                <Sequence>
                    <Wait duration="2.5" />
                    <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
                    <Wait duration="0.5" />
                </Sequence>
            </RecoveryNode>
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Condition ID="DefaultTeamColorCondition">
            <input_port default="purple" name="default_color">purple, yellow</input_port>
        </Condition>
        <Action ID="DynamixelCommandAction">
            <input_port default="0" name="position">[deg]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="dynamixel_command/arm_left_motor_base" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="5" name="tolerance">[deg]</input_port>
            <input_port default="200" name="velocity">[deg/s]</input_port>
        </Action>
        <Control ID="IfTeamColorThenElseControl">
            <input_port default="purple" name="color">purple, yellow</input_port>
        </Control>
        <Action ID="LiftCommandAction">
            <input_port default="0" name="height">[cm]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="dynamixel_command/lift_motor" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="0.5" name="tolerance">[cm]</input_port>
            <input_port default="8" name="velocity">[cm/s]</input_port>
        </Action>
        <Action ID="MotionCommandAction">
            <input_port default="0" name="acceleration_angular">[rad/s^2]</input_port>
            <input_port default="0" name="acceleration_linear">[m/s^2]</input_port>
            <input_port name="command">[forward/rotate_relative/rotate_absolute]</input_port>
            <output_port name="result">[success/drift]</output_port>
            <input_port default="0" name="value">value to pass to motion function, in meters or radians</input_port>
            <input_port default="0" name="velocity_angular">[rad/s]</input_port>
            <input_port default="0" name="velocity_linear">[m/s]</input_port>
        </Action>
        <Action ID="NavigateToAction">
            <input_port name="behavior_tree" />
            <input_port name="goal" />
        </Action>
        <Action ID="PreciseNavigateToAction">
            <input_port name="behavior_tree">Behavior tree</input_port>
            <input_port default="0;0;0" name="goal">A target pose in format "x;y;theta".</input_port>
        </Action>
        <Action ID="ResistanceMeterAction">
            <input_port default="1000" name="resistance">[Ohms]</input_port>
            <input_port default="resistance_meter/left" name="server_name">Action server name</input_port>
            <input_port default="10" name="tolerance">[%]</input_port>
        </Action>
        <Action ID="ScoreboardTaskAction">
            <input_port default="0" name="points">points scored, can be negative</input_port>
            <input_port default="store_sample_to_work_shed" name="task">unique task name</input_port>
        </Action>
        <Control ID="TaskSequenceControl" />
        <Action ID="VacuumPumpCommandAction">
            <input_port default="0" name="connect">0 - disconnect, 1 - connected</input_port>
            <output_port default="0" name="result">0 - disconnected, 1 - connected, 2 - couldn't disconnect, 3 - couldn't connect, 4 - other</output_port>
            <input_port default="vacuum_pump_command/arm_left_connector" name="server_name">Action server name</input_port>
        </Action>
        <Action ID="WaitMatchStartAction">
            <input_port default="2" name="state">0 = unarmed; 1 = armed; 2 = started</input_port>
        </Action>
        <SubTree ID="skill_measure_and_toggle">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_retract_hands">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_swap">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_excavation_squares">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_move_green_sample">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_replica_and_statuette">
            <input_port name="__shared_blackboard" />
        </SubTree>
    </TreeNodesModel>
    <!-- ////////// -->
</root>
