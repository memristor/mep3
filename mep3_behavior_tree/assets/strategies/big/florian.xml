<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <SequenceStar>

            <WaitMatchStart state="1"/>

            <Motion command="forward" velocity_linear="0.5" acceleration_linear="0.5" velocity_angular="6.0" acceleration_angular="8.0" value="0" />
            <SubTree ID="skill_retract_hands" __shared_blackboard="true" />

            <WaitMatchStart state="2"/>
                
            <TaskSequence>
                
                <SubTree ID="task_excavation_squares" __shared_blackboard="true" />
                <SubTree ID="task_replica_and_statuette" __shared_blackboard="true" />
                <SubTree ID="task_collect_and_deploy_static_pucks" __shared_blackboard="true"/> 
            </TaskSequence>
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="skill_measure_and_toggle">
        <ForceSuccess>
            <Sequence>
                <Wait duration="0.3" />
                <ForceSuccess>
                    <Dynamixel label="measure_left" velocity="360" position="190" />
                </ForceSuccess>
                <Fallback>
                    <Delay delay_msec="300">
                        <ResistanceMeter label="left" resistance="420" tolerance="30" />
                    </Delay>
                    <ForceFailure>
                        <Dynamixel label="measure_left" velocity="360" position="215" />
                    </ForceFailure>
                </Fallback>
                <Dynamixel label="measure_left" velocity="360" position="215" />
                <Dynamixel label="pusher_left" velocity="540" position="145" />
                <Dynamixel label="pusher_left" velocity="540" position="235" />
                <ScoreboardTask points="5" task="task_excavation_squares"/>
            </Sequence>
        </ForceSuccess>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="task_collect_and_deploy_static_pucks">
	<Sequence>
        	<!-- <SubTreePlus ID="SafePreciseNavigate" goal="0.620;0.710;-90" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /> -->
            <SubTreePlus ID="SafePreciseNavigate" goal="0.64;0.710;-90" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />

	        <Parallel failure_threshold="1" success_threshold="2">
			    <!-- <Dynamixel label="flipper_right" position="295"/> -->
			    <!-- <Dynamixel label="flipper_left" position="0"/> -->
                <Dynamixel label="flipper_right" position="257"/>
			    <Dynamixel label="flipper_left" position="41"/>
		    </Parallel>

	        <Motion value="0.6" command="forward"/>

	        <Parallel failure_threshold="1" success_threshold="2">
			    <!-- <Dynamixel label="flipper_right" position="257"/> -->
                <Dynamixel label="flipper_right" position="245"/>
			    <!-- <Dynamixel label="flipper_left" position="41"/> -->
                <Dynamixel label="flipper_left" position="50"/>
		    </Parallel>

        	<!-- <Navigate goal="1.05;-0.55;-45"/> -->
            <Navigate goal="1.030;-0.520;-45"/>
            <PreciseNavigate goal="1.060;-0.550;-45"/>
            <!-- <NavigateThrough goal="1.07;-0.55;-45|"/> -->

	        <Motion value="0.15" command="forward"/>

	        <Parallel failure_threshold="1" success_threshold="2">
			    <Dynamixel label="flipper_right" position="295"/>
			    <Dynamixel label="flipper_left" position="0"/>
		    </Parallel>

	        <!-- <Motion value="-0.24" command="forward"/> -->
            <Motion value="-0.09" command="forward"/>

	        <Parallel failure_threshold="1" success_threshold="2">
                <!-- <Dynamixel label="flipper_right" position="220"/>
			    <Dynamixel label="flipper_left" position="65"/> -->
                <Dynamixel label="flipper_right" position="210"/>
                <Dynamixel label="flipper_left" position="87"/>
		    </Parallel>

            <!-- Stuck guraj ispod -->
            <ForceSuccess>
    	        <Motion value="0.400" command="forward"/>
            </ForceSuccess>
            <ScoreboardTask points="15" task="three_pucks_under"/>

            <Wait duration="0.2" />

	        <Motion value="-0.220" command="forward"/>

            <Parallel failure_threshold="1" success_threshold="2">
                <Dynamixel label="flipper_right" velocity="450" position="151" />
                <Dynamixel label="flipper_left" velocity="450" position="146" />
            </Parallel>

	</Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_retract_hands">
        <Parallel failure_threshold="1" success_threshold="9">
            <Dynamixel label="flipper_right" velocity="50" position="151" />
            <Dynamixel label="flipper_left" velocity="50" position="146" />
            <Dynamixel label="front_right" velocity="50" position="247" />
            <Dynamixel label="front_left" velocity="50" position="140" />
            <Dynamixel label="box" velocity="50" position="150" />
            <Dynamixel label="measure_left" velocity="50" position="267" />
            <Dynamixel label="measure_right"  velocity="50" position="30" />
            <Dynamixel label="pusher_left" velocity="50" position="235" />
            <Dynamixel label="pusher_right" velocity="50" position="60" />
        </Parallel>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="task_excavation_squares">
        <Fallback>
        	<Sequence>
        	    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
        	    
                <SubTreePlus ID="SafePreciseNavigate" goal="0.700;-0.100;150" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />

        	    <SubTreePlus ID="SafePreciseNavigate" goal="-0.300;-0.800;150" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                
                <!-- Priprema -->
                <!--NavigateThrough goal="1.049;-0.07;180|0.539;-0.089;150|0.079;-0.089;150|-0.071;-0.408;150|-0.300;-0.800;150"/-->
        	    
                <SequenceStar>

                        <Sequence>
                            <!--Sedma plocica-->
                            <SubTreePlus ID="SafePreciseNavigate" goal="-0.250;-0.82;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
                        </Sequence>
                        
                        <Sequence>
                            <!--Sesta plocica-->
                            <SubTreePlus ID="SafePreciseNavigate" goal="-0.060;-0.820;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
                        </Sequence>

                        <Sequence>
                            <!--Peta plocica-->
                            <SubTreePlus ID="SafePreciseNavigate" goal="0.120;-0.820;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
                        </Sequence>

                        <Sequence>
                            <!--Cetvrta plocica-->
                            <SubTreePlus ID="SafePreciseNavigate" goal="0.300;-0.820;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
                        </Sequence>

                        <Sequence>
                            <!--Treca plocica-->
                            <!-- <SubTreePlus ID="SafePreciseNavigate" goal="0.490;-0.820;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /> -->
                            <SubTreePlus ID="SafePreciseNavigate" goal="0.485;-0.820;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
                        </Sequence>

                        <Sequence>
                            <!--Druga plocica-->
                            <SubTreePlus ID="SafePreciseNavigate" goal="0.680;-0.820;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                            <Dynamixel label="pusher_left" velocity="540" position="145" />
                            <Dynamixel label="pusher_left" velocity="540" position="235" />  
                            <ScoreboardTask points="10" task="task_excavation_squares"/>
                        </Sequence>

                        <Sequence>
                            <!--Prva plocica-->
                            <!-- <SubTreePlus ID="SafePreciseNavigate" goal="0.870;-0.82;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /> -->
                            <SubTreePlus ID="SafePreciseNavigate" goal="0.860;-0.82;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                            <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
                        </Sequence>

                        <Dynamixel label="measure_left" velocity="540" position="267" />

                </SequenceStar>
                <SubTreePlus ID="SafePreciseNavigate" goal="0.740;-0.780;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                <!--Kada zavrsi spusti ruku-->
                <Dynamixel label="measure_left" velocity="540" position="267" />
        	</Sequence>
            <Sequence>
                <Dynamixel label="measure_left" velocity="540" position="267" />
                <SubTreePlus ID="SafePreciseNavigate" goal="0.860;-0.82;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                <SubTreePlus ID="SafePreciseNavigate" goal="0.740;-0.780;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
            </Sequence>
        </Fallback>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="task_replica_and_statuette">
        <SequenceStar>
            <!--Navigate behavior_tree="" goal="1;-0.45;60" /-->
            <!-- <SubTreePlus ID="SafePreciseNavigate" goal="1.050;-0.316;75" type="backward" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /> -->
            <Sequence>
                <SubTreePlus ID="SafePreciseNavigate" goal="1.050;-0.550;165" type="backward" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
                <!--PreciseNavigate behavior_tree="backward" goal="1.05;-0.55;135" /-->
                <ForceSuccess>
                    <PreciseNavigate behavior_tree="backward" goal="1.165;-0.665;135" />
                </ForceSuccess>

                <!-- Uzmi kocku -->
                <ScoreboardTask points="4" task="begin_action" />
                <Dynamixel label="box" timeout="2" position="72" velocity="100" />
                <ScoreboardTask points="5" task="remove_statuette_from_pedestal" />
                <ScoreboardTask points="10" task="install_replica_on_pedestal" />
                <Motion value="0.3" command="forward" />
            </Sequence>
            <Sequence>
                <Motion command="forward" velocity_linear="0.5" velocity_angular="6.0" acceleration_angular="8.0" value="0" />
                
                <!-- Ostavi statuetu u kucicu -->
                <PreciseNavigate behavior_tree="backward" goal="1.27;0.83;-90" />
                <ForceSuccess>
                    <Motion value="-0.064" command="forward" />
                </ForceSuccess>
                <Dynamixel label="box" position="160" velocity="540" />
                <ScoreboardTask points="15" task="install_statuette_on_display_cabinet" />
                <ScoreboardTask points="5" task="install_statuette_in_hause" />

                <Motion value="0.2" command="forward" />
            </Sequence>
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="SafePreciseNavigate">
        <RecoveryNode number_of_retries="3" name="FollowPath">
            <PreciseNavigate goal="{goal}" behavior_tree="{type}" />
            <Sequence>
                <Wait duration="0.5" />
                <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
                <Wait duration="0.5" />
            </Sequence>
        </RecoveryNode>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Condition ID="DefaultTeamColorCondition">
            <input_port default="purple" name="default_color">purple, yellow</input_port>
        </Condition>
        <Action ID="Dynamixel">
            <input_port default="0" name="position">[deg]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="arm_left_motor_base" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="8" name="tolerance">[deg]</input_port>
            <input_port default="90" name="velocity">[deg/s]</input_port>
        </Action>
        <Control ID="IfTeamColorThenElseControl">
            <input_port default="purple" name="color">purple, yellow</input_port>
        </Control>
        <Action ID="Lift">
            <input_port default="0" name="height">[cm]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="lift_motor" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="0.5" name="tolerance">[cm]</input_port>
            <input_port default="8" name="velocity">[cm/s]</input_port>
        </Action>
        <Action ID="Motion">
            <input_port default="0" name="acceleration_angular">[rad/s^2]</input_port>
            <input_port default="0" name="acceleration_linear">[m/s^2]</input_port>
            <input_port name="command">[forward/rotate_relative/rotate_absolute]</input_port>
            <output_port name="result">[success/drift]</output_port>
            <input_port default="0" name="value">value to pass to motion function, in meters or radians</input_port>
            <input_port default="0" name="velocity_angular">[rad/s]</input_port>
            <input_port default="0" name="velocity_linear">[m/s]</input_port>
        </Action>
        <Action ID="Navigate">
            <input_port name="behavior_tree" />
            <input_port name="goal" />
        </Action>
        <Action ID="PreciseNavigate">
            <input_port name="behavior_tree">Behavior tree</input_port>
            <input_port default="0;0;0" name="goal">A target pose in format "x;y;theta".</input_port>
        </Action>
        <Action ID="ResistanceMeter">
            <input_port default="1000" name="resistance">[Ohms]</input_port>
            <input_port default="left" name="server_name">Action server name</input_port>
            <input_port default="10" name="tolerance">[%]</input_port>
        </Action>
        <Action ID="ScoreboardTask">
            <input_port default="0" name="points">points scored, can be negative</input_port>
            <input_port default="store_sample_to_work_shed" name="task">unique task name</input_port>
        </Action>
        <Control ID="TaskSequenceControl" />
        <Action ID="VacuumPump">
            <input_port default="0" name="connect">0 - disconnect, 1 - connected</input_port>
            <output_port default="0" name="result">0 - disconnected, 1 - connected, 2 - couldn't disconnect, 3 - couldn't connect, 4 - other</output_port>
            <input_port default="arm_left_connector" name="server_name">Action server name</input_port>
        </Action>
        <Action ID="WaitMatchStart">
            <input_port default="2" name="state">0 = unarmed; 1 = armed; 2 = started</input_port>
        </Action>
        <SubTree ID="skill_measure_and_toggle">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_retract_hands">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_excavation_squares">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_replica_and_statuette">
            <input_port name="__shared_blackboard" />
        </SubTree>
    </TreeNodesModel>
    <!-- ////////// -->
</root>
