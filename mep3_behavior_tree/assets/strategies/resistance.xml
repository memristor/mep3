<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <SequenceStar>
            <Condition ID="DefaultTeamColorCondition" default_color="purple" />
           <!-- Set parameters -->
           <Switch2 case_1="2" case_2="3" variable="{table}">
                <Sequence name="table_2_config">
                    <SetBlackboard output_key="pose_home" value="1.0491;0;0"/>
                </Sequence>
                <Sequence name="table_3_config">
                    <SetBlackboard output_key="pose_home" value="1.0491;0;0"/>
                </Sequence>
                <Sequence name="table_1_config">
                    <SetBlackboard output_key="pose_home" value="1.0491;0;0"/>
                </Sequence>
            </Switch2>

            <Motion command="forward" velocity_linear="1.2" acceleration_linear="0.7" velocity_angular="7.0" acceleration_angular="8.0" value="0" />

            <WaitMatchStart state="2" />
        	    <ScoreboardTask points="10" task="task_excavation_squares"/>
	    <SequenceStar>
		    <ForceSuccess>
			<Timeout msec="100000">
			    <Sequence>

			    <ForceSuccess>
				<Timeout msec="85000">
				    <Sequence>
				    <TaskSequence>
					<SubTree ID="task_excavation_squares" __shared_blackboard="true" />
				    </TaskSequence>
				    <Wait duration="5.0" name="Wait 5 s" />
				    <Dynamixel label="hand_side_Dz" position="90" />
				    <Dynamixel label="hand_side_G" position="-90" velocity="90" />
				    <!-- CHANGE THIS TO ANNOY OPPONENT-->
				    <!--SubTreePlus ID="SafePreciseNavigate" goal="0.6;-0.65;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /-->
				    <SubTreePlus ID="SafePreciseNavigate" goal="0;-0.1;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
			    	    <!--Navigate goal="0;-0.1;180" /-->
				    <Wait duration="40" />
				    </Sequence>
				</Timeout>
			    </ForceSuccess>

			    <!-- Go home -->
            		    <Dynamixel label="hand_side_Dz" velocity="540" position="90" />
			    <Dynamixel label="hand_side_G" velocity="45" position="-90" />
			    <!-- IF WE ANNOY OPPONENT, CHANGE TO NAVIGATE -->
			    <!--SubTreePlus ID="SafePreciseNavigate" goal="{pose_home}" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /-->
			    <Navigate goal="{pose_home}" />
			    <!-- Stop the motion driver / `can_id` and `message` must be decimals, not hexadecimals. -->
			    </Sequence>
			</Timeout>
		    </ForceSuccess>
	    </SequenceStar>

            <Dynamixel label="hand_side_Dz" velocity="90" position="90" />
            <Dynamixel label="hand_side_G" velocity="90" position="-90" />
            <CanbusSend can_id="512" message="15" />
            <Dynamixel label="arm_right_motor_base" velocity="777" />
            <Wait duration="10000.0" name="Wait Indefinitely" />
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="skill_measure_and_toggle">
        <ForceSuccess>
            <Sequence>
                <ForceSuccess>
<<<<<<< HEAD
                    <Dynamixel label="hand_side_Dz" velocity="360" position="20" />
=======
                    <Dynamixel label="hand_side_Dz" velocity="540" position="20" />
>>>>>>> main
                </ForceSuccess>
                <Fallback>
                    <Delay delay_msec="100">
                        <ResistanceMeter label="left" resistance="420" tolerance="30" />
                    </Delay>
                    <ForceFailure>
                        <Dynamixel label="hand_side_Dz" velocity="540" position="90" />
                    </ForceFailure>
                </Fallback>
                <Dynamixel label="hand_side_Dz" velocity="540" position="90" />
                <Dynamixel label="hand_side_G" velocity="540" position="-90" />
                <Dynamixel label="hand_side_G" velocity="540" position="45" />
                <ScoreboardTask points="5" task="task_excavation_squares"/>
            </Sequence>
        </ForceSuccess>
    </BehaviorTree>
    <!-- ////////// -->
<<<<<<< HEAD
<<<<<<< HEAD:mep3_behavior_tree/assets/strategies/resistance.xml
=======
>>>>>>> main
    
    <!-- ////////// -->
    <BehaviorTree ID="push_solids_from_pedestal">
        <Sequence>
          <SubTreePlus ID="SafePreciseNavigate" goal="0.97;-0.45;45" type="forward" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
           <PreciseNavigate behavior_tree="" goal="1.14;-0.629;45" />
		   <Dynamixel label="arm_right_motor_base" position="-106" />
           <Parallel failure_threshold="1" success_threshold="3">
			   	<Dynamixel label="arm_right_motor_mid" position="44" />
			   	<Dynamixel label="arm_right_motor_gripper" position="14" />
          		<VacuumPump label="arm_right_connector" connect="1" />
           </Parallel>
           <Dynamixel label="arm_right_motor_mid" position="55" />
           <Motion value="0.06" command="forward"/>
           <Parallel failure_threshold="1" success_threshold="2">
			   	<Dynamixel label="arm_right_motor_mid" position="44" />
		  		<VacuumPump label="arm_right_connector" connect="0" />     	
           </Parallel>
           <Motion value="0.06" command="backward"/>
           <Dynamixel label="arm_right_motor_mid" position="55" />
           <Motion value="0.06" command="forward"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="skill_retract_hands">
        <Parallel failure_threshold="1" success_threshold="9">
            <Dynamixel label="arm_right_motor_base" velocity="540" position="0" />
            <Dynamixel label="arm_right_motor_mid" velocity="540" position="-5" />
            <Dynamixel label="arm_right_motor_gripper" velocity="540" position="0" />
            <Dynamixel label="arm_left_motor_base" velocity="540" position="0" />
            <Dynamixel label="arm_left_motor_mid" velocity="540" position="-5" />
            <Dynamixel label="arm_left_motor_gripper" velocity="540" position="0" />
            <Dynamixel label="hand_mid_L"  velocity="540" position="0" />
            <Dynamixel label="hand_side_G" velocity="540" position="45" />
            <Dynamixel label="hand_side_Dz" velocity="540" position="90" />
        </Parallel>
    </BehaviorTree>
    <!-- ////////// -->
<<<<<<< HEAD
=======
>>>>>>> main:mep3_behavior_tree/assets/strategies/homologation_resistance.xml
=======
>>>>>>> main
    <BehaviorTree ID="task_excavation_squares">
        <Fallback>
        	<Sequence>
        	    <!-- <Dynamixel label="hand_side_Dz" velocity="360" position="45" /> -->
<<<<<<< HEAD
        	    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
        	    <PreciseNavigate behavior_tree="" goal="0.793;-0.7819;180" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.607;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <Dynamixel label="hand_side_Dz" velocity="360" position="90" />
        	    <Dynamixel label="hand_side_G" velocity="540" position="-90" />
        	    <Dynamixel label="hand_side_G" velocity="540" position="45" />
        	    <ScoreboardTask points="10" task="task_excavation_squares"/>

        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.423;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.238;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.0525;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
        	    <SubTreePlus ID="SafePreciseNavigate" goal="-0.1325;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
        	    <SubTreePlus ID="SafePreciseNavigate" goal="-0.318;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
        	    <Dynamixel label="hand_side_Dz" position="90" />
        	    <Dynamixel label="hand_side_G" position="-90" velocity="90" />
=======


		    <Parallel failure_threshold="1" success_threshold="2">
			    <!--SubTreePlus ID="SafePreciseNavigate" goal="0.607;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" /-->
			    <PreciseNavigate goal="0.607;-0.7819;180" />
			    <Dynamixel label="hand_side_G" velocity="540" position="45" />
		    </Parallel>
		    <Dynamixel label="hand_side_G" velocity="540" position="-90" />
		    <Dynamixel label="hand_side_G" velocity="540" position="45" />
		    <Motion command="forward" velocity_linear="0.7" acceleration_linear="0.9" velocity_angular="8.0" acceleration_angular="10.0" value="0" />


        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.423;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />


        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.238;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />

			    
        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.0525;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />


        	    <SubTreePlus ID="SafePreciseNavigate" goal="-0.1325;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />


        	    <SubTreePlus ID="SafePreciseNavigate" goal="-0.318;-0.7819;180" type="safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />


        	    <Dynamixel label="hand_side_Dz" position="90" />
        	    <Dynamixel label="hand_side_G" position="-90" velocity="90" />
		    <SubTreePlus ID="SafePreciseNavigate" goal="0.607;-0.7819;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
		    <Dynamixel label="hand_side_G" velocity="540" position="45" />

        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.793;-0.7819;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
        	    <!--PreciseNavigate behavior_tree="" goal="0.793;-0.7819;180" /-->
        	    <SubTree ID="skill_measure_and_toggle" __shared_blackboard="true" />
        	    <Dynamixel label="hand_side_G" position="-90" velocity="45"/>
>>>>>>> main
        	</Sequence>
        	<Sequence name="failed measurement - retract G and Dz hands">
        	    <Dynamixel label="hand_side_Dz" position="90" />
        	    <Dynamixel label="hand_side_G" position="-90" velocity="90" />
<<<<<<< HEAD
=======
		    <Motion value="-0.1" command="forward" />
        	    <SubTreePlus ID="SafePreciseNavigate" goal="0.793;-0.7319;180" type="backward_safe" node="{node}" bt_loop_duration="{bt_loop_duration}" server_timeout="{server_timeout}" />
	            <AlwaysFailure/>
>>>>>>> main
        	</Sequence>
        </Fallback>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="SafePreciseNavigate">
        <SequenceStar>
            <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
            <RecoveryNode number_of_retries="3" name="FollowPath">
                <PreciseNavigate goal="{goal}" behavior_tree="{type}" />
                <Sequence>
                    <Wait duration="2.5" />
                    <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
                    <Wait duration="0.5" />
                </Sequence>
            </RecoveryNode>
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Condition ID="DefaultTeamColorCondition">
            <input_port default="purple" name="default_color">purple, yellow</input_port>
        </Condition>
        <Action ID="Dynamixel">
            <input_port default="0" name="position">[deg]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="arm_left_motor_base" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="8" name="tolerance">[deg]</input_port>
            <input_port default="90" name="velocity">[deg/s]</input_port>
        </Action>
        <Control ID="IfTeamColorThenElseControl">
            <input_port default="purple" name="color">purple, yellow</input_port>
        </Control>
        <Action ID="Lift">
            <input_port default="0" name="height">[cm]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="lift_motor" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="0.5" name="tolerance">[cm]</input_port>
            <input_port default="8" name="velocity">[cm/s]</input_port>
        </Action>
        <Action ID="Motion">
            <input_port default="0" name="acceleration_angular">[rad/s^2]</input_port>
            <input_port default="0" name="acceleration_linear">[m/s^2]</input_port>
            <input_port name="command">[forward/rotate_relative/rotate_absolute]</input_port>
            <output_port name="result">[success/drift]</output_port>
            <input_port default="0" name="value">value to pass to motion function, in meters or radians</input_port>
            <input_port default="0" name="velocity_angular">[rad/s]</input_port>
            <input_port default="0" name="velocity_linear">[m/s]</input_port>
        </Action>
        <Action ID="Navigate">
            <input_port name="behavior_tree" />
            <input_port name="goal" />
        </Action>
        <Action ID="PreciseNavigate">
            <input_port name="behavior_tree">Behavior tree</input_port>
            <input_port default="0;0;0" name="goal">A target pose in format "x;y;theta".</input_port>
        </Action>
        <Action ID="ResistanceMeter">
            <input_port default="1000" name="resistance">[Ohms]</input_port>
            <input_port default="left" name="server_name">Action server name</input_port>
            <input_port default="10" name="tolerance">[%]</input_port>
        </Action>
        <Action ID="ScoreboardTask">
            <input_port default="0" name="points">points scored, can be negative</input_port>
            <input_port default="store_sample_to_work_shed" name="task">unique task name</input_port>
        </Action>
        <Control ID="TaskSequenceControl" />
        <Action ID="VacuumPump">
            <input_port default="0" name="connect">0 - disconnect, 1 - connected</input_port>
            <output_port default="0" name="result">0 - disconnected, 1 - connected, 2 - couldn't disconnect, 3 - couldn't connect, 4 - other</output_port>
            <input_port default="arm_left_connector" name="server_name">Action server name</input_port>
        </Action>
        <Action ID="WaitMatchStart">
            <input_port default="2" name="state">0 = unarmed; 1 = armed; 2 = started</input_port>
        </Action>
        <SubTree ID="skill_measure_and_toggle">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_retract_hands">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_swap">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_excavation_squares">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_move_green_sample">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_replica_and_statuette">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="push_solids_from_pedestal">
            <input_port name="__shared_blackboard" />
        </SubTree>
    </TreeNodesModel>
    <!-- ////////// -->
</root>
