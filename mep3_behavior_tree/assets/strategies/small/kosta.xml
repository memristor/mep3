<root main_tree_to_execute="BehaviorTree">
    <!-- ////////// -->
    <BehaviorTree ID="BehaviorTree">
        <SequenceStar>
            
            <Motion command="forward" velocity_linear="0.8" velocity_angular="6.0" acceleration_angular="8.0" value="0" /> 

            <!--WaitMatchStart state="2" /-->
            <!--Wait duration="1" /-->
            <!-- <ForceSuccess>
                <Motion command="forward" value="-0.500" /> 
            </ForceSuccess>
            <Wait duration="9999999.0" /> -->
	    <Sequence>

		    <SubTree ID="collect_from_dispenser_middle_far" __shared_blackboard="true" />

		    <SubTree ID="collect_from_dispenser_middle_ours" __shared_blackboard="true" />


                    <PreciseNavigate goal="0.44;0.735;0"/>

		    <!-- Ostavljanje pakova -->

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.325;0.740;0" behavior_tree="backward"/>
			    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_first_from_left" __shared_blackboard="true" />
		    <SubTree ID="leave_down_iz_daleka" __shared_blackboard="true" />

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.425;0.760;0"/>
			    <SubTree ID="skill_prepare_for_right" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_first_from_right" __shared_blackboard="true" />
		    <SubTree ID="leave_down" __shared_blackboard="true" />

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.585;0.762;0"/>
			    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_second_from_left" __shared_blackboard="true" />
		    <SubTree ID="leave_down" __shared_blackboard="true" />

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.700;0.765;0"/>
			    <SubTree ID="skill_prepare_for_right" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_second_from_right" __shared_blackboard="true" />
		    <SubTree ID="leave_down" __shared_blackboard="true" />

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.950;0.768;0"/>
			    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_third_from_left" __shared_blackboard="true" />
		    <SubTree ID="leave_down" __shared_blackboard="true" />

		    <Parallel failure_threshold="1" success_threshold="2">
			    <Motion command="forward" value="-0.08" /> 
			    <SubTree ID="skill_prepare_for_right" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_third_from_right" __shared_blackboard="true" />
		    <SubTree ID="leave_up" __shared_blackboard="true" />
			    
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />

		    <PreciseNavigate goal="1.1;0.755;0"/>

		    <SubTree ID="collect_from_dispenser_only_ours" __shared_blackboard="true"/>

                    <PreciseNavigate goal="0.24;0.715;0"/>
                    <PreciseNavigate goal="0.55;0.750;0"/>

		    <!-- Ostavljanje pakova gornji red -->

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.315;0.767;0" behavior_tree="backward"/>
			    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_first_from_left" __shared_blackboard="true" />
		    <SubTree ID="leave_up" __shared_blackboard="true" />

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.575;0.765;0"/>
			    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_second_from_left" __shared_blackboard="true" />
		    <SubTree ID="leave_up" __shared_blackboard="true" />

		    <Parallel failure_threshold="1" success_threshold="2">
			    <PreciseNavigate goal="0.760;0.765;0"/>
			    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
		    </Parallel>
		    <SubTree ID="skill_take_third_from_left" __shared_blackboard="true" />
		    <SubTree ID="leave_up" __shared_blackboard="true" />

		    <PreciseNavigate goal="1.1;0.740;0"/>

		    <!-- Go home -->
    	    </Sequence>

            <!-- Stop the motion driver / `can_id` and `message` must be decimals, not hexadecimals. -->
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <BehaviorTree ID="skill_retract_hands">
        <Sequence>

            <Parallel failure_threshold="1" success_threshold="4">
                <Dynamixel label="mid" position="30" velocity="450"/>
                <Dynamixel label="gripper" position="180" velocity="450"/>
                <Dynamixel label="base" position="67" velocity="450"/>
                <Dynamixel label="rail" position="68" velocity="450"/>
            </Parallel>

            <Parallel failure_threshold="1" success_threshold="2">
                <Dynamixel label="fork_right" position="85" velocity="450"/>
                <Dynamixel label="fork_left" position="270" velocity="450"/>
            </Parallel>

        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_prepare_for_right">
        <Sequence>

            <Parallel failure_threshold="1" success_threshold="3">
                <Dynamixel label="mid" position="35" velocity="450"/>
                <Dynamixel label="gripper" position="180" velocity="450"/>
                <Dynamixel label="rail" position="97" velocity="450"/>
            </Parallel>
		    
	    <Dynamixel label="base" position="240" velocity="450"/>

            <Parallel failure_threshold="1" success_threshold="2">
                <Dynamixel label="fork_right" position="85" velocity="450"/>
                <Dynamixel label="fork_left" position="270" velocity="450"/>
            </Parallel>

        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_take_first_from_left">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="5">
                <Dynamixel label="fork_left" position="230" velocity="450"/>
                <Dynamixel label="rail" position="68" velocity="450"/>
                <Dynamixel label="base" position="80" velocity="450"/>
                <Dynamixel label="gripper" position="250" velocity="450"/>
                <VacuumPump label="robot_left_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="70" velocity="250"/>

            <SubTree ID="skill_prepare_to_leave_from_left" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_take_second_from_left">
        <Sequence>
            <Parallel failure_threshold="1" success_threshold="5">
                <Dynamixel label="fork_left" position="230" velocity="450"/>
                <Dynamixel label="rail" position="68" velocity="450"/>
                <Dynamixel label="base" position="80" velocity="450"/>
                <Dynamixel label="gripper" position="240" velocity="450"/>
                <VacuumPump label="robot_left_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="80" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_left" __shared_blackboard="true" />
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_take_third_from_left">
        <Sequence>
            <Parallel failure_threshold="1" success_threshold="5">
                <Dynamixel label="fork_left" position="230" velocity="450"/>
                <Dynamixel label="rail" position="68" velocity="450"/>
                <Dynamixel label="base" position="80" velocity="450"/>
                <Dynamixel label="gripper" position="230" velocity="450"/>
                <VacuumPump label="robot_left_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="90" velocity="250"/>
	    
	    <SubTree ID="skill_prepare_to_leave_from_left" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_take_first_from_right">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="5">
                <Dynamixel label="fork_right" position="125" velocity="450"/>
                <Dynamixel label="rail" position="90" velocity="450"/>
                <Dynamixel label="base" position="223" velocity="450"/>
                <Dynamixel label="gripper" position="250" velocity="450"/>
                <VacuumPump label="robot_left_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="65" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_right" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_take_second_from_right">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="5">
                <Dynamixel label="fork_right" position="125" velocity="450"/>
                <Dynamixel label="rail" position="90" velocity="450"/>
                <Dynamixel label="base" position="223" velocity="450"/>
                <Dynamixel label="gripper" position="240" velocity="450"/>
                <VacuumPump label="robot_left_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="75" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_right" __shared_blackboard="true" />

        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_take_third_from_right">
        <Sequence>
	
            <Parallel failure_threshold="1" success_threshold="5">
                <Dynamixel label="fork_right" position="125" velocity="450"/>
                <Dynamixel label="rail" position="90" velocity="250"/>
                <Dynamixel label="base" position="223" velocity="250"/>
                <Dynamixel label="gripper" position="230" velocity="250"/>
                <VacuumPump label="robot_left_connector" connect="1"/>	
            </Parallel>

            <Dynamixel label="mid" position="85" velocity="250"/>

	    <SubTree ID="skill_prepare_to_leave_from_right" __shared_blackboard="true" />


        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_prepare_to_leave_from_right">
        <Sequence>	
	    <Dynamixel label="fork_right" position="135" velocity="250"/>
		    
	    <Dynamixel label="mid" position="30" velocity="150"/>
	    <Dynamixel label="gripper" position="200" velocity="150"/>

            <Parallel failure_threshold="1" success_threshold="2">
                <Dynamixel label="base" position="67" velocity="150"/>
                <Dynamixel label="rail" position="115" velocity="150"/>
            </Parallel>

	    <Dynamixel label="fork_left" position="270" velocity="450"/>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="skill_prepare_to_leave_from_left">
        <Sequence>	
	    <Dynamixel label="fork_left" position="230" velocity="450"/>
		    
	    <Dynamixel label="mid" position="35" velocity="150"/>
            <Parallel failure_threshold="1" success_threshold="3">
		    <Dynamixel label="gripper" position="200" velocity="150"/>
		    <Dynamixel label="rail" position="115" velocity="150"/>
		    <Dynamixel label="base" position="67" velocity="150"/>
            </Parallel>
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="leave_down">
        <Sequence>
	
	    <Parallel success_threshold="1" failure_threshold="3">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="gripper" position="159" velocity="250"/>
		    <Dynamixel label="base" position="67" velocity="250"/>
	 	    <Dynamixel label="rail" position="120" velocity="250"/>
	    </Parallel>
	    <Dynamixel label="mid" position="82" velocity="50"/>
	    <!--Motion command="forward" value="-0.010" /--> 
	    <VacuumPump label="robot_left_connector" connect="0"/>	

	    <Parallel success_threshold="1" failure_threshold="2">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="rail" position="82" velocity="250"/>
	    </Parallel>
		
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="leave_down_iz_daleka">
        <Sequence>
	
	    <Parallel success_threshold="1" failure_threshold="3">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="gripper" position="150" velocity="250"/>
		    <Dynamixel label="base" position="67" velocity="250"/>
		    <Dynamixel label="rail" position="126" velocity="250"/>
	    </Parallel>
	    <Dynamixel label="mid" position="82" velocity="100"/>
	    <Wait duration="0.2" />
	    <VacuumPump label="robot_left_connector" connect="0"/>	

	    <Parallel success_threshold="1" failure_threshold="2">     
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="rail" position="82" velocity="250"/>
	    </Parallel>
		
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="leave_up">
        <Sequence>
	
	    <Dynamixel label="gripper" position="147" velocity="250"/>
	    <Dynamixel label="mid" position="40" velocity="100"/>
	    
            <Wait duration="0.2" />
	    <VacuumPump label="robot_left_connector" connect="0"/>	
            <Wait duration="0.5" />

	    <Parallel success_threshold="1" failure_threshold="3">     

		    <Dynamixel label="gripper" position="200" velocity="250"/>
		    <Dynamixel label="mid" position="30" velocity="250"/>
		    <Dynamixel label="rail" position="82" velocity="250"/>
            </Parallel>

        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="collect_from_dispenser_middle_far">
        <Sequence>
	    <Parallel failure_threshold="1" success_threshold="2">
		    <SubTree ID="skill_retract_hands" __shared_blackboard="true" />
		    <PreciseNavigate goal="-0.226;0.300;90"/>
	    </Parallel>
	    
	    <Parallel failure_threshold="1" success_threshold="3">
		    <PreciseNavigate goal="-0.226;0.600;90"/>
		    <Dynamixel label="fork_right" position="180" velocity="450"/>
		    <Dynamixel label="rail" position="97" velocity="450"/>
	    </Parallel>
	    
	    <PreciseNavigate goal="-0.226;0.788;90"/>
        
        <!-- Prepare for stuck -->
        <!-- <PreciseNavigate goal="-0.226;0.750;90"/> -->
        <!-- Stuck -->        
        <!-- <ForceSuccess> -->
            <!-- <Motion command="forward" value="0.500" />  -->
        <!-- </ForceSuccess> -->

	    <Parallel failure_threshold="1" success_threshold="3">
		    <Dynamixel label="fork_right" position="85" velocity="150"/>
		    <Dynamixel label="rail" position="82" velocity="200"/>
		    <PreciseNavigate goal="-0.226;0.500;90" behavior_tree="backward"/>
	    </Parallel>
	
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="collect_from_dispenser_middle_ours">
        <Sequence>

	    <PreciseNavigate goal="0.226;0.500;90"/>
	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="0.226;0.600;90"/>
		    <Dynamixel label="fork_left" position="175" velocity="450"/>
	    </Parallel>
	    
	    <PreciseNavigate goal="0.226;0.788;90"/>

        <!-- Prepare for stuck -->
        <!-- <PreciseNavigate goal="0.226;0.75;90"/> -->
        <!-- Stuck -->
        <!-- <ForceSuccess>
          <Motion command="forward" value="0.500" /> 
        </ForceSuccess> -->

	    <Parallel failure_threshold="1" success_threshold="2">
		    <Dynamixel label="fork_left" position="270" velocity="150"/>
		    <PreciseNavigate goal="0.226;0.700;90" behavior_tree="backward"/>
	    </Parallel>
	
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="collect_from_dispenser_only_ours">
        <Sequence>

	    <PreciseNavigate goal="1.180;-0.326;0"/>
	    <Parallel failure_threshold="1" success_threshold="2">
		    <PreciseNavigate goal="1.244;-0.326;0"/>
		    <Dynamixel label="fork_left" position="175" velocity="450"/>
	    </Parallel>
	    
	    <PreciseNavigate goal="1.288;-0.326;0"/>

        <!-- Prepare for stuck -->
        <!-- <PreciseNavigate goal="1.25;-0.326;0"/> -->
        <!-- Stuck -->
        <!-- <ForceSuccess> -->
            <!-- <Motion command="forward" value="0.500" /> -->
        <!-- </ForceSuccess> -->
        
	    <Parallel failure_threshold="1" success_threshold="2">
		    <Dynamixel label="fork_left" position="270" velocity="150"/>
		    <PreciseNavigate goal="1.100;-0.326;0" behavior_tree="backward"/>
	    </Parallel>
	
        </Sequence>
    </BehaviorTree>
    <!-- ////////// -->
    <!-- ////////// -->
    <BehaviorTree ID="SafePreciseNavigate">
        <SequenceStar>
            <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
            <RecoveryNode number_of_retries="3" name="FollowPath">
                <PreciseNavigate goal="{goal}" behavior_tree="{type}" />
                <Sequence>
                    <Wait duration="2.5" />
                    <ClearEntireCostmap name="ClearLocalCostmap-Context" service_name="local_costmap/clear_entirely_local_costmap" />
                    <Wait duration="0.5" />
                </Sequence>
            </RecoveryNode>
        </SequenceStar>
    </BehaviorTree>
    <!-- ////////// -->
    <TreeNodesModel>
        <Condition ID="DefaultTeamColorCondition">
            <input_port default="purple" name="default_color">purple, yellow</input_port>
        </Condition>
        <Action ID="DynamixelCommandAction">
            <input_port default="0" name="position">[deg]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="dynamixel_command/arm_left_motor_base" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="5" name="tolerance">[deg]</input_port>
            <input_port default="200" name="velocity">[deg/s]</input_port>
        </Action>
        <Control ID="IfTeamColorThenElseControl">
            <input_port default="purple" name="color">purple, yellow</input_port>
        </Control>
        <Action ID="LiftCommandAction">
            <input_port default="0" name="height">[cm]</input_port>
            <output_port default="0" name="result">0 - success, 1 - timeout, 2 - other error</output_port>
            <input_port default="dynamixel_command/lift_motor" name="server_name">Action server name</input_port>
            <input_port default="5" name="timeout">[s]</input_port>
            <input_port default="0.5" name="tolerance">[cm]</input_port>
            <input_port default="8" name="velocity">[cm/s]</input_port>
        </Action>
        <Action ID="MotionCommandAction">
            <input_port default="0" name="acceleration_angular">[rad/s^2]</input_port>
            <input_port default="0" name="acceleration_linear">[m/s^2]</input_port>
            <input_port name="command">[forward/rotate_relative/rotate_absolute]</input_port>
            <output_port name="result">[success/drift]</output_port>
            <input_port default="0" name="value">value to pass to motion function, in meters or radians</input_port>
            <input_port default="0" name="velocity_angular">[rad/s]</input_port>
            <input_port default="0" name="velocity_linear">[m/s]</input_port>
        </Action>
        <Action ID="NavigateToAction">
            <input_port name="behavior_tree" />
            <input_port name="goal" />
        </Action>
        <Action ID="PreciseNavigateToAction">
            <input_port name="behavior_tree">Behavior tree</input_port>
            <input_port default="0;0;0" name="goal">A target pose in format "x;y;theta".</input_port>
        </Action>
        <Action ID="ResistanceMeterAction">
            <input_port default="1000" name="resistance">[Ohms]</input_port>
            <input_port default="resistance_meter/left" name="server_name">Action server name</input_port>
            <input_port default="10" name="tolerance">[%]</input_port>
        </Action>
        <Action ID="ScoreboardTaskAction">
            <input_port default="0" name="points">points scored, can be negative</input_port>
            <input_port default="store_sample_to_work_shed" name="task">unique task name</input_port>
        </Action>
        <Control ID="TaskSequenceControl" />
        <Action ID="VacuumPumpCommandAction">
            <input_port default="0" name="connect">0 - disconnect, 1 - connected</input_port>
            <output_port default="0" name="result">0 - disconnected, 1 - connected, 2 - couldn't disconnect, 3 - couldn't connect, 4 - other</output_port>
            <input_port default="vacuum_pump_command/arm_left_connector" name="server_name">Action server name</input_port>
        </Action>
        <Action ID="WaitMatchStartAction">
            <input_port default="2" name="state">0 = unarmed; 1 = armed; 2 = started</input_port>
        </Action>
        <SubTree ID="skill_measure_and_toggle">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_retract_hands">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_prepare_for_right">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_prepare_for_left">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
	<SubTree ID="skill_prepare_to_leave_from_right">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
	<SubTree ID="skill_prepare_to_leave_from_left">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_take_first_from_left">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
	<SubTree ID="skill_take_second_from_left">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_take_third_from_left">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_take_second_from_right">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_take_third_from_right">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_take_first_from_right">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="leave_down">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="leave_up">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="skill_swap">
            <input_port default="true" name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_excavation_squares">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_move_green_sample">
            <input_port name="__shared_blackboard" />
        </SubTree>
        <SubTree ID="task_replica_and_statuette">
            <input_port name="__shared_blackboard" />
        </SubTree>
    </TreeNodesModel>
    <!-- ////////// -->
</root>
